# PRD 可行性审核与建议（针对 `PRD.md`）

## 总体结论（可行性）
整体方向可行：做一个本地客户端，支持批量导入 PDF/图片，按队列串行调用 PaddleOCR-VL API，并输出 Markdown 文件。你在 PRD 里已经选了较稳的技术栈（Python + PySide6 + 打包 EXE），也正确识别了最大阻碍在于 **API 细节未确认**。

要做到你强调的“足够方便、稳定性高”，PRD 还需要把 **接口形态、PDF 多页策略、失败恢复机制、输出规范** 写清楚，否则实现阶段会反复返工。

---

## 关键阻碍 / 需补全的信息（最高优先级）

### 1) API 调用形态与限制（必须写成可执行的接口契约）
PRD 需要明确以下信息（建议直接在 PRD 增加“API 契约”章节）：
- **鉴权方式**：API Key / Access Token / Cookie？是否需要刷新 token？
- **Endpoint**：固定 URL？还是 AI Studio “服务/应用”每个项目不同？
- **输入**：支持 `pdf` 直传还是必须逐页图片？支持 base64 / multipart？
- **文件限制**：单文件大小、像素、页数、QPS、并发上限、日配额/计费。
- **输出**：是否直接返回 Markdown？若返回结构化 JSON（blocks/table/latex），需要你自定义渲染为 Markdown。
- **耗时与异步**：是同步返回还是提交任务后轮询？（这决定 UI 进度与重试策略）

> PRD 当前“可能是 Gradio 应用需 gradio_client”的提醒很好，但需要落地为“如果是 A 则用方案 A/如果是 B 则用方案 B”的选择标准。

#### 基于你给的官方 DOC，可直接落地的接口要点
- **鉴权**：请求头使用 `Authorization: token <TOKEN>`，`Content-Type: application/json`。（来源：官方 DOC）
- **主要接口**：`POST /layout-parsing` 做版面解析（文档里称 `infer`）。（来源：官方 DOC）
- **输入**：`file` 支持“服务器可访问的图片/PDF URL”或“文件内容 Base64”；`fileType` 取 `0=PDF`、`1=图片`（如果是 URL 可不传并由服务推断）。（来源：官方 DOC）
- **输出**：`result.layoutParsingResults` 对图片是长度 1，对 PDF 是每页一个元素；每页都有 `markdown.text` 与 `markdown.images`（图片相对路径→图像内容）。（来源：官方 DOC）
- **多页重构**：存在 `POST /restructure-pages`（跨页表格合并、标题级别识别、拼接页面、Markdown 美化等）。（来源：官方 DOC）

> 注意：不同文档版本对“PDF 默认处理页数上限”描述不一致（有文档写超 10 页只处理前 10 页，有文档写超 100 页只处理前 100 页），PRD 里必须明确你最终采用的模型/页面与限制，并在产品里做超页提示。（来源：官方 DOC）

### 2) PDF 多页与版面处理（决定产品体验）
必须明确：
- **分页策略**：逐页识别还是整 PDF 识别？逐页时 Markdown 如何合并（加 `# Page n`？）
- **顺序与一致性**：页序保证、跨页表格/段落如何处理。
- **嵌入图片/图表**：Markdown 是否需要把图片导出并引用？还是只保留文字？

### 3) “稳定性高”落地指标（否则无法验收）
建议在 PRD 给出可验收的 SLO/指标：
- 单文件成功率目标（例如：在网络正常时 ≥ 99%）
- 超时与重试策略（次数、退避、哪些错误可重试）
- 断点续跑：失败/中断后可从队列继续，不重复已完成文件
- 日志可追溯：每个文件都有 request_id / 错误原因 / 耗时

#### 基于官方配额/错误码，PRD 应明确的“稳定性约束”
- **单日配额**：每用户/每模型每日解析页数上限 3000 页；超额返回 429。（来源：官方配额/错误码文档）
- **单文件页数建议**：建议单文件不超过 100 页；超过时仅解析前 100 页（其余忽略）。（来源：官方配额/错误码文档）
- **常见错误码**：403（Token 错/URL 与 Token 不匹配）、429（超配额）、503（请求过多）、504（网关超时）等——这些需要映射到 UI 文案与重试/不重试策略。（来源：官方配额/错误码文档）

---

## 功能与交互建议（提高“方便”）

### 1) 任务队列能力（推荐做“最小但好用”）
- **可暂停/继续/取消**：尤其是长 PDF（几十页）时很关键。
- **失败重试按钮**：对失败项一键重试，而不是重新跑全队列。
- **输出预览**：至少提供“打开输出目录/打开 md”快捷入口。
- **配置入口**：API Key、输出目录、是否覆盖同名文件、重试次数等。

### 2) 输出文件规范（避免混乱）
PRD 建议明确：
- 命名：`原文件名.md`，PDF 可选 `原文件名.page-001.md` 或单文件合并。
- 同名冲突：自动追加时间戳或 `(1)`。
- 编码：UTF-8。
- 结构：标题/页分隔/表格/公式（若支持 LaTeX，统一用 `$...$` 或 `$$...$$`）。
- 默认输出目录：如固定使用 `E:\\output\\`，建议仍提供设置项，并为每个输入文件创建独立子目录（含 `merged_result.md` 与 images），避免图片路径/文件名冲突。

### 3) 进度的定义（UI 里“进度条”要有含义）
如果是逐页：进度 = 已完成页数 / 总页数；如果是整文件同步：进度只能做“旋转加载 + 超时倒计时”，避免假进度。

---

## 技术方案建议（在你现有 PRD 基础上补强）

### 1) 架构拆分（降低返工）
- **Core**：文件扫描/队列/重试/输出渲染（纯 Python，无 UI 依赖）
- **Adapter**：API 调用层（REST / Gradio 两种实现，运行时择一）
- **UI**：PySide6 展示与交互（通过信号/回调订阅 Core 事件）

这样即使未来你改为 Web 前端或命令行，也能复用 Core。

### 2) 并发与限流
你写“避免并发过高”是对的；建议明确：
- 默认 **串行**（并发=1），可在设置中改为 2~3（若 API 允许）
- 加 **令牌桶/间隔**（例如每次请求至少间隔 X ms），对抗 QPS 限制

### 3) 重试与错误分类（稳定性的核心）
PRD 建议写清规则：
- 可重试：网络超时、连接失败、5xx、限流（429）
- 不可重试：鉴权失败、参数错误、文件过大/格式不支持
- 退避：指数退避 + 抖动（例如 1s/2s/4s…）

### 4) PDF 处理库预选
如果 API 不支持 PDF 直传，你需要在本地转图片：
- 优先候选：PyMuPDF（fitz）/ pdf2image（依赖 poppler）——PRD 可先写“待选型”，但要标注对打包体积与安装依赖的影响。

---

## 建议补充的 PRD 章节（直接可加到文档里）
- **范围/非范围**：不做账号体系、不做云同步、不做多人协作；是否支持 Windows-only。
- **配置与安装**：API Key 放哪里（本地配置文件）、导入/导出配置。
- **异常与边界**：大文件、空白页、扫描件倾斜、加密 PDF、图片超大。
- **验收标准**：功能点逐条可验收（见下）。

---

## 可执行验收标准（示例）
1. 可拖拽/多选导入至少 50 个文件，按列表顺序处理。
2. 任意任务失败不阻断队列，失败原因可见且可一键重试。
3. 处理中可暂停/继续，关闭软件后再次打开可继续未完成任务（至少“跳过已完成”）。
4. 输出 Markdown 为 UTF-8，命名规则一致；可一键打开输出目录。
5. 断网后自动重试并在网络恢复后继续；超过重试次数后标记失败并记录日志。
